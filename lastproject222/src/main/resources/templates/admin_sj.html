<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
<meta charset="UTF-8" name="viewport" content="width=device-width, initial-scale=1.0"/>
<style>
	html,body{
		height:100%;
		width:100%;
	}
	.nav-wrapper{
		padding-left:10px;
		padding-rigth:10px;
	}
	section{
		margin-left:150px;
		height:100%;
		background-color:#e0e0e0;
	}
	/* report.html */
	.repo_table{
		/* margin-top:50px; */
		padding-top:50px;
	}
	
	/* 모달크기 */
	.modalsize{
		width:80%;
		height:80%;
		align:center;
	}
</style>
</head>
<body>
	<!-- 메뉴바 -->
	<header>
		<nav>
    	<div class="nav-wrapper white">
      		<a href="#" class="brand-logo center black-text">admin</a>
      		<a href="#" data-target="sidenav-left" class="sidnav-trigger"><i class="material-icons black-text">menu</i></a>
      		<!-- 메뉴 클릭했을때 안열림 & main 다 가리는거 수정하기 -->
    		<ul id="sidenav-left" class="sidenav sidenav-fixed">
        		<li><a th:href="@{/admin_sj}">상점관리</a></li>
        		<li><a th:href="@{/admin_user}">회원관리</a></li>
        		<li><a th:href="@{/admin_report}">신고리스트</a></li>
        		<li><a href="#">정지</a>
      		</ul>
    	</div>
  		</nav>
	</header>
	<section>
	<div class="container">
		<div class="row repo_table">
		<!-- 상점판매순위 -->
			<div id="charts" class="col s12 card">
			<!-- 최고매출상점 -->
			</div>
			
			<!-- 상점목록 -->
			<div class="col s12 card">
				<div id="index1" class="col s12 white">
					<table>
						<thead>
							<tr><th>상점이름</th><th>상점이메일</th><th>입점신청서</th><th>입점신청날짜</th><th>승인</th><th>승인날짜</th></tr>
						</thead>
						<tbody>
							<tr class="rows" th:each="list:${storelist}">
								<td th:class="name" th:text="${list.storename}"></td>
								<td th:class="email" th:text="${list.storeemail}"></td>
								<!-- <td><a  class="detail_btn modal-trigger">상세보기</a></td> -->
								<td><a th:href="'#shopdetail'+${list.storeseq}" class="modal-trigger">상세보기</a></td>
								<td th:text="${list.requestdate}"></td>
								<td><label><input type="checkbox" name="approve"><span></span></label></td><!--입점승인  -->
								<td class="seq" th:text="${list.storeseq}" style="display:none;"></td>
								<td th:class="confirmdate" th:text="${list.confirmdate}"></td>
								<!-- 모달 -->
								<th:block>
									<div class="modal modalsize" th:id="shopdetail+${list.storeseq}">
										<div class="modal-content">
									
										<h3>입점신청서</h3>
										<div class="divider"></div>
											<div class="row">
											<h5>1. 등록하실 상점 이름을 입력해주세요</h5>
											<p th:text="${list.storename}"></p>
											</div>
										<div class="row">
											<h5>2.상점에 대한 설명을 작성해주세요</h5>
											<p th:text="${list.storedetail}"></p>
										</div>
										<div class="row">
											<h5>3.입점하려는 업종을 선택해주세요</h5>
											<p th:text="${list.storetype}"></p>
										</div>
										<div class="row">
											<h5>4.사업자 등록증을 추가해주세요</h5>
											<div id="shop" th:text="${list.storefile}" style="display:none;"></div>
											<div id="storefiles" style="width:100%; height:100%"></div>
										</div>
										<div class="row">
											<h5>5.입점완료 메일을 받을 주소를 입력하세요</h5>
											<p th:text="${list.storeemail}"></p>
										</div>
								
									<div class="modal-footer">
									 <button type="reset" class="btn modal-close">닫기</button>
									</div>
									</div>
								</div>
						</th:block>
							</tr>
						</tbody>
					</table>
					
					
				</div>
			</div>
		</div>
	</div>
	</section>
	<!-- 푸터 들어가기  -->
<!-- 자바스크립트 -->
<script src="http://code.jquery.com/jquery-3.4.1.min.js"></script>	
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script><!-- 구글차트 -->
<script>
function drawChart() {

    var data = new google.visualization.DataTable();
    /* 데이터 가져왔을때 이부분 수정 */
    data.addColumn('string', 'Topping');
    data.addColumn('number', 'Slices');
    data.addRows([
      ['Mushrooms', 3],
      ['Onions', 1],
      ['Olives', 1],
      ['Zucchini', 1],
      ['Pepperoni', 2]]);
      /* 수정끝! */
      var options = {'title':'최고매출상점',
              'width':400,
              'height':300};
      var chart = new google.visualization.PieChart(document.getElementById('charts'));
      chart.draw(data, options);
}
$(document).ready(function(){

	google.charts.load('current', {'packages':['corechart']});
	google.charts.setOnLoadCallback(drawChart);
	
	var tr,email,seq;
	
	//입점날짜 있으면 체크박스 체크
	$('.confirmdate').each(function(index,item){
		var check=$(this).parent().children().eq(4).children().children();
		if($(this).text()!=""){
			check.prop("checked",true);
			check.attr("disabled",true);
		}
	});
	
	//상점상세보기
	$('.modal').modal({ 
		onOpenStart:function(){
		$("#storefiles").empty();
		 var files=$("#shop").html().split(',');
		 for(var i in files){
			$("#storefiles").append("<img src='storefiles/"+files[i]+"' style='width:50%; height:100%'>")
		 }
		}
	});
	var seq=new Array();
	$('.seq').each(function(i){
		seq[i]=$(this).text();
	});
	
	//이거수정해야함!!-----------------------------------
	//승인버튼 눌렀을때
	$('.rows').each(function(i){
		tr=$(this);
		
		$('input:checkbox[name="approve"]:eq('+i+')').on("change",function(){
			email=tr.children().eq(1).text();
			var result=confirm("입점신청을 승인하시겠습니까?");
			if(result){
				$.ajax({
					type:'POST',
					url:'/approve',
					data:JSON.stringify({"email":email,"seq":seq[i]}),
					dataType:'json',
					contentType:"application/json; charset=UTF-8",
					cache:false,
					success:function(data){
						if(data.email_ok==1&&data.store_update==1){
							/* location.href = location.href; */
							history.go(0);
						}
					},
					error:function(data){
						console.log(data);
					}
				});
			}else{
				$(this).prop("checked",false);
				return;
			}
		});
	});
	
	
	
	
}); 
</script>
</body>
</html>